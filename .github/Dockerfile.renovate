# Custom Renovate image with pipeline-migration-tool
# Based on MintMaker's self-hosted Renovate example

FROM renovate/renovate:39

USER root

# Install Python 3.12+ (required by pipeline-migration-tool), pip, and other dependencies
RUN apt-get update && \
    apt-get install -y --no-install-recommends \
    software-properties-common \
    && add-apt-repository ppa:deadsnakes/ppa -y \
    && apt-get update \
    && apt-get install -y --no-install-recommends \
    python3.12 \
    python3.12-venv \
    python3-pip \
    git \
    curl \
    ca-certificates \
    && rm -rf /var/lib/apt/lists/*

# Set python3.12 as default python3
RUN update-alternatives --install /usr/bin/python3 python3 /usr/bin/python3.12 1

# Install yq (required by migration scripts)
RUN curl -L https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64 -o /usr/bin/yq && \
    chmod +x /usr/bin/yq

# Install pipeline-migration-tool using pip
RUN pip3 install --break-system-packages git+https://github.com/konflux-ci/pipeline-migration-tool.git && \
    echo "=== Checking where pipeline-migration-tool was installed ===" && \
    find /usr -name "pipeline-migration-tool" 2>/dev/null || true && \
    ls -la /usr/local/bin/ | grep -i pipeline || echo "Not in /usr/local/bin" && \
    python3 -m pip show pipeline-migration-tool

# Create symlink if needed
RUN if [ ! -f /usr/local/bin/pipeline-migration-tool ]; then \
    TOOL_PATH=$(find /usr -name "pipeline-migration-tool" -type f 2>/dev/null | head -1); \
    if [ -n "$TOOL_PATH" ]; then \
        ln -s "$TOOL_PATH" /usr/local/bin/pipeline-migration-tool; \
    fi; \
    fi

# Verify installations work
RUN which yq && yq --version
RUN python3 --version
RUN python3 -m pipeline_migration --help || pipeline-migration-tool --help

USER ubuntu

# Ensure PATH is set for ubuntu user as well
ENV PATH="/usr/local/bin:${PATH}"

LABEL org.opencontainers.image.source="https://github.com/zxiong/konflux-probe-test-templates"
LABEL org.opencontainers.image.description="Renovate with pipeline-migration-tool for automatic Tekton task migrations"
